{% extends "admin_base.html" %}
{% block title %}Usuarios - Admin{% endblock %}
{% block content %}
<h2>Usuarios</h2>

<!-- Indicador de búsqueda activa -->
{% if q_name or q_email or q_phone or q_segment %}
<div class="search-active-indicator">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
  <span>Búsqueda activa</span>
  <a href="/admin/users" class="btn-back" style="margin-left: auto;">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    Ver todos
  </a>
</div>
{% endif %}

<!-- Botón para mostrar/ocultar buscador -->
<button class="search-toggle" onclick="toggleSearch('userSearch')">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
  Buscar usuarios
</button>

<!-- Buscador colapsable -->
<div id="userSearch" class="search-bar collapsed">
  <h3>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
    Filtrar usuarios
  </h3>
  <form method="get" action="/admin/users" class="search-form">
    <input type="text" name="q_name" placeholder="Nombre" value="{{ q_name or '' }}">
    <input type="email" name="q_email" placeholder="Email" value="{{ q_email or '' }}">
    <input type="text" name="q_phone" placeholder="Teléfono" value="{{ q_phone or '' }}">
    <input type="text" name="q_segment" placeholder="Segmento" value="{{ q_segment or '' }}">
    <div class="search-actions">
      <button type="submit" class="btn-search">Buscar</button>
      <a href="/admin/users" class="btn-clear">Limpiar</a>
    </div>
  </form>
</div>

<!-- Botón para mostrar/ocultar formulario de creación -->
<button class="search-toggle" onclick="toggleSearch('userForm')">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 5v14M5 12h14"/>
  </svg>
  Nuevo usuario
</button>

<section id="userForm" class="form-section collapsed">
  <h3>Nuevo usuario</h3>
  <form method="post" action="/admin/users" class="form-grid">
    <input type="text" name="name" placeholder="Nombre" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="text" name="phone" placeholder="Teléfono">
    <input type="text" name="segment" placeholder="Segmento" value="nuevo">
    <button type="submit">Guardar Usuario</button>
  </form>

  <h3 style="margin-top: 32px;">Importar usuarios desde CSV</h3>
  <form method="post" action="/admin/users/import" enctype="multipart/form-data" class="upload-form">
    <input type="file" name="file" accept=".csv" required>
    <button type="submit">Subir CSV</button>
    <p class="help-text">
      Campos esperados: <code>name,email,phone,segment</code> (o <code>nombre,email,telefono,segmento</code>).
    </p>
  </form>
</section>

<table class="table">
  <thead>
    <tr>
      <th>ID</th><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Segmento</th><th>Profesión</th><th>Empresa</th><th>Creado</th><th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  {% for u in users %}
    <tr>
      <td>{{ u.id }}</td>
      <td>{{ u.name }}</td>
      <td>{{ u.email }}</td>
      <td>{{ u.phone }}</td>
      <td>{{ u.segment }}</td>
      <td>{{ u.profession or '-' }}</td>
      <td>{{ u.company or '-' }}</td>
      <td>{{ u.created_at }}</td>
      <td>
        <div class="action-buttons">
          <a href="/admin/users/{{ u.id }}/edit" class="btn-icon btn-edit" title="Editar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </a>
          <form method="post" action="/admin/users/{{ u.id }}/delete" style="display: inline;" onsubmit="return confirm('¿Eliminar este usuario y todos sus datos relacionados?')">
            <button type="submit" class="btn-icon btn-delete" title="Eliminar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </form>
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
function toggleSearch(id) {
  const searchBar = document.getElementById(id);
  searchBar.classList.toggle('collapsed');
}
</script>
{% endblock %}