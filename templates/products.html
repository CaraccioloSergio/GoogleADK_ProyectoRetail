{% extends "admin_base.html" %}
{% block title %}Productos - Admin{% endblock %}
{% block content %}
<h2>Productos</h2>

<!-- Indicador de búsqueda activa -->
{% if q_sku or q_name or q_category or q_offer %}
<div class="search-active-indicator">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
  <span>Búsqueda activa</span>
  <a href="/admin/products" class="btn-back" style="margin-left: auto;">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    Ver todos
  </a>
</div>
{% endif %}

<!-- Botón para mostrar/ocultar buscador -->
<button class="search-toggle" onclick="toggleSearch('productSearch')">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
  Buscar productos
</button>

<!-- Buscador colapsable -->
<div id="productSearch" class="search-bar collapsed">
  <h3>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
    Filtrar productos
  </h3>
  <form method="get" action="/admin/products" class="search-form">
    <input type="text" name="q_sku" placeholder="SKU" value="{{ q_sku or '' }}">
    <input type="text" name="q_name" placeholder="Nombre" value="{{ q_name or '' }}">
    <input type="text" name="q_category" placeholder="Categoría" value="{{ q_category or '' }}">
    <label class="checkbox-inline" style="padding: 10px 0;">
      <input type="checkbox" name="q_offer" {% if q_offer %}checked{% endif %}> Solo ofertas
    </label>
    <div class="search-actions">
      <button type="submit" class="btn-search">Buscar</button>
      <a href="/admin/products" class="btn-clear">Limpiar</a>
    </div>
  </form>
</div>

<section class="form-section">
  <h3>Nuevo producto</h3>
  <form method="post" action="/admin/products" class="form-grid">
    <input type="text" name="sku" placeholder="SKU" required>
    <input type="text" name="name" placeholder="Nombre" required>
    <input type="number" step="0.01" name="price" placeholder="Precio" required>
    <input type="text" name="category" placeholder="Categoría">
    <input type="number" name="stock" placeholder="Stock" value="0">

    <label class="checkbox-inline">
      <input type="checkbox" name="is_offer"> En oferta
    </label>

    <textarea name="description" placeholder="Descripción" rows="2"></textarea>

    <button type="submit">Guardar Producto</button>
  </form>

  <h3 style="margin-top: 32px;">Importar productos desde CSV</h3>

  <form method="post" action="/admin/products/import" enctype="multipart/form-data" class="upload-form">
    <input type="file" name="file" accept=".csv" required>
    <button type="submit">Subir CSV</button>

    <p class="help-text">
      Campos esperados:
      <code>sku,name,price,category,description,stock,is_offer</code><br>
      También acepta variantes en español: <code>nombre,precio,categoria,descripcion,oferta</code>.
    </p>
  </form>
</section>

<table class="table">
  <thead>
    <tr>
      <th>ID</th><th>SKU</th><th>Nombre</th><th>Categoría</th>
      <th>Precio</th><th>Oferta</th><th>Stock</th><th>Última actualización</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  {% for p in products %}
    <tr>
      <td>{{ p.id }}</td>
      <td><code>{{ p.sku }}</code></td>
      <td>{{ p.name }}</td>
      <td>{{ p.category }}</td>
      <td>${{ "%.2f"|format(p.price) }}</td>
      <td>
        {% if p.is_offer %}
          <span class="badge badge-success">Sí</span>
        {% else %}
          <span class="badge badge-neutral">No</span>
        {% endif %}
      </td>
      <td>{{ p.stock }}</td>
      <td>{{ p.updated_at }}</td>
      <td>
        <div class="action-buttons">
          <a href="/admin/products/{{ p.id }}/edit" class="btn-icon btn-edit" title="Editar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </a>
          <form method="post" action="/admin/products/{{ p.id }}/delete" style="display: inline;" onsubmit="return confirm('¿Eliminar este producto?')">
            <button type="submit" class="btn-icon btn-delete" title="Eliminar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </form>
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
function toggleSearch(id) {
  const searchBar = document.getElementById(id);
  searchBar.classList.toggle('collapsed');
}
</script>
{% endblock %}